<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reporte Técnico – Equipos Médicos (simple)</title>
  <meta name="description" content="Reporte técnico (PDF, consecutivo, firma y fotos) sin Service Worker." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root { --bg:#0b1020; --card:#121a34; --muted:#8aa0c6; --text:#ebf0ff; --border:#253055; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0a0f1e,#0b1228 40%,#09102a);color:var(--text)}
    header{position:sticky;top:0;z-index:5;background:rgba(9,16,42,.7);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    h1{margin:0;font-size:1.4rem;font-weight:800}
    .row{display:grid;grid-template-columns:1fr;gap:18px}
    @media (min-width:1100px){.row{grid-template-columns:560px 1fr;align-items:start}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .card h2{margin:0 0 10px;font-size:1.1rem}
    label{display:block;margin:10px 0 6px;color:var(--muted);font-size:.92rem}
    input[type="text"],input[type="number"],input[type="date"],input[type="time"],input[type="email"],textarea,select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:#0f1732;color:var(--text);outline:none}
    textarea{min-height:90px;resize:vertical}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .grid-4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px}
    .muted{color:var(--muted);font-size:.9rem}
    .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px}
    button,.btn{appearance:none;border:1px solid var(--border);background:#101a35;color:var(--text);border-radius:14px;padding:10px 14px;font-weight:600;cursor:pointer;box-shadow:var(--shadow)}
    button.primary{background:#2d7bd9;border-color:#2d7bd9}
    button.success{background:#18a877;border-color:#159569}
    button.danger{background:#e74a3b;border-color:#c0392b}
    .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(84px,1fr));gap:8px;margin-top:8px}
    .thumbs img{width:100%;height:74px;object-fit:cover;border-radius:10px;border:1px solid var(--border)}
    canvas#sigPad{width:100%;height:170px;background:#0f1732;border:1px dashed #2c3b6a;border-radius:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
    th{color:var(--muted);font-weight:600}
    .right{text-align:right}
    .nowrap{white-space:nowrap}
    .footer{color:var(--muted);font-size:.85rem;margin-top:8px}
  </style>
</head>
<body>
  <header>
    <div class="wrap"><h1>Reportes Técnicos – Versión Simple (sin offline)</h1></div>
  </header>

  <main class="wrap">
    <div class="row">
      <!-- Formulario -->
      <section class="card">
        <h2>Nuevo reporte</h2>
        <form id="reporteForm">
          <div class="grid-4">
            <div>
              <label>N° de reporte (consecutivo)</label>
              <input type="text" id="numReporte" readonly />
            </div>
            <div>
              <label>Fecha</label>
              <input type="date" id="fecha" required />
            </div>
            <div>
              <label>Hora inicio</label>
              <input type="time" id="horaIni" required />
            </div>
            <div>
              <label>Hora fin</label>
              <input type="time" id="horaFin" required />
            </div>
          </div>

          <div class="grid-3">
            <div>
              <label>Cliente / Clínica / Hospital</label>
              <input type="text" id="cliente" required placeholder="Ej. Clínica Santa María" />
            </div>
            <div>
              <label>Responsable en sitio</label>
              <input type="text" id="responsable" required />
            </div>
            <div>
              <label>Correo del cliente (para enviar PDF)</label>
              <input type="email" id="correo" placeholder="cliente@ejemplo.com" />
            </div>
          </div>

          <h3 class="muted">Equipo atendido</h3>
          <div class="grid-3">
            <div><label>Marca</label><input type="text" id="marca" required /></div>
            <div><label>Modelo</label><input type="text" id="modelo" required /></div>
            <div><label>N° de serie</label><input type="text" id="serie" required /></div>
          </div>

          <div class="grid-2">
            <div>
              <label>Actuación</label>
              <select id="actuacion">
                <option>Mtto Preventivo</option>
                <option>Mtto Correctivo</option>
                <option>Instalación de Repuesto</option>
                <option>Otro</option>
              </select>
            </div>
            <div>
              <label>Cantidad</label>
              <input type="number" id="cantidad" step="0.1" min="0" value="1" />
            </div>
          </div>

          <label>Descripción de falla / solicitud</label>
          <textarea id="falla" required></textarea>

          <label>Observaciones / diagnóstico</label>
          <textarea id="acciones" required></textarea>

          <div class="grid-3">
            <div><label>Repuestos utilizados</label><input type="text" id="repuestos" placeholder="Separar por coma" /></div>
            <div><label>Horas trabajadas</label><input type="number" id="horas" step="0.1" min="0" value="1" /></div>
            <div>
              <label>Estado final</label>
              <select id="estado">
                <option>Operativo</option>
                <option>Operativo con observaciones</option>
                <option>En espera de repuesto</option>
                <option>No operativo</option>
              </select>
            </div>
          </div>

          <label>Fotografías (evidencia) — usa la cámara del móvil</label>
          <input type="file" id="fotos" accept="image/*" capture="environment" multiple />
          <div id="thumbs" class="thumbs"></div>

          <div class="grid-2">
            <div>
              <label>Logo empresa (opcional)</label>
              <input type="file" id="logo" accept="image/*" />
              <div class="btns"><button type="button" id="fijarLogo" class="btn">Guardar logo como fijo</button></div>
            </div>
            <div>
              <label>Firma del cliente</label>
              <canvas id="sigPad"></canvas>
              <div class="btns"><button type="button" id="limpiarFirma" class="btn">Limpiar firma</button></div>
            </div>
          </div>

          <div class="btns">
            <button type="button" class="primary" id="guardar">Guardar local</button>
            <button type="button" class="success" id="pdf">Generar PDF</button>
            <button type="reset" class="danger">Limpiar formulario</button>
          </div>
          <div class="footer">Consecutivo y datos en <strong>localStorage</strong>. Sin Service Worker.</div>
        </form>
      </section>

      <!-- Lista -->
      <section class="card">
        <h2>Reportes guardados</h2>
        <table>
          <thead><tr><th>Reporte</th><th>Fecha</th><th>Cliente</th><th>Equipo</th><th class="right">Acciones</th></tr></thead>
          <tbody id="tabla"></tbody>
        </table>
        <div class="btns">
          <button id="exportarTodo" class="btn">Exportar JSON</button>
          <button id="importarBtn" class="btn">Importar JSON</button>
          <input type="file" id="importarInput" accept="application/json" style="display:none" />
        </div>
      </section>
    </div>
    <p class="footer">PDF: logo grande, cabecera empresa, DATOS DEL CLIENTE, ACTUACIONES/CANTIDAD, Observaciones, fotos y firma.</p>
  </main>

  <!-- jsPDF (UMD) con fallback -->
  <script id="jspdf-cdn"
          src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"
          onload="window.__JSPDF_OK=true"></script>
  <script>
    if (!window.__JSPDF_OK) {
      var s = document.createElement('script');
      s.src = 'https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js';
      s.onload = function(){ window.__JSPDF_OK = true; };
      document.head.appendChild(s);
    }
  </script>

  <!-- Signature Pad (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@5.0.10/dist/signature_pad.umd.min.js"></script>

  <script>
    /*************** Datos de empresa (cabecera PDF) — edítalos a gusto ***************/
    const HEADER = {
      company:   'Bennu Healthcare Solutions',
      legalId:   '3-101804878',
      address:   'Sabana Sur, Mata Redonda, Centro Comercial del Sur',
      email:     'jacuna@bennucr.com',
      phone:     'Teléfono: 83485676',
      technician:'Técnico: Ing. Juan Carlos Acuña Lopez'
    };

    /*************** Persistencia: reportes + consecutivo + logo fijo ***************/
    const LS_KEY_REPORTES = 'reportes_simple_list';
    const LS_KEY_CONSEC   = 'reportes_simple_consecutivo'; // arranca en 56 -> siguiente 57
    const LS_KEY_LOGO     = 'reportes_simple_logo_fijo';

    function loadReportes(){ try{ return JSON.parse(localStorage.getItem(LS_KEY_REPORTES) || '[]'); }catch(e){ return []; } }
    function saveReportes(arr){ localStorage.setItem(LS_KEY_REPORTES, JSON.stringify(arr)); }

    function getNextConsecutivo(){
      let n = parseInt(localStorage.getItem(LS_KEY_CONSEC) || '56', 10);
      const next = n + 1; localStorage.setItem(LS_KEY_CONSEC, String(next));
      return next;
    }
    function peekConsecutivo(){
      let n = parseInt(localStorage.getItem(LS_KEY_CONSEC) || '56', 10);
      return n + 1;
    }

    function getLogoFijo(){ return localStorage.getItem(LS_KEY_LOGO); }
    function setLogoFijo(dataURL){ localStorage.setItem(LS_KEY_LOGO, dataURL); }

    /*************** Firma ***************/
    const canvas = document.getElementById('sigPad');
    const signaturePad = new window.SignaturePad(canvas, { backgroundColor: 'rgba(0,0,0,0)' });
    function resizeCanvas(){
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      canvas.width = canvas.offsetWidth * ratio;
      canvas.height = canvas.offsetHeight * ratio;
      canvas.getContext('2d').scale(ratio, ratio);
      signaturePad.clear();
    }
    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('orientationchange', resizeCanvas);
    document.getElementById('limpiarFirma').addEventListener('click', () => signaturePad.clear());

    /*************** Logo ***************/
    const logoInput = document.getElementById('logo');
    let logoDataURL = getLogoFijo() || null;
    logoInput.addEventListener('change', async (ev) => {
      const f = ev.target.files?.[0];
      logoDataURL = f ? await fileToDataURL(f) : null;
    });
    document.getElementById('fijarLogo').addEventListener('click', () => {
      if (!logoDataURL) { alert('Carga un logo primero.
