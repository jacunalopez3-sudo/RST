<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reporte Técnico – Equipos Médicos (simple)</title>
  <meta name="description" content="Reporte técnico (PDF, consecutivo, firma y fotos) sin Service Worker." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1020; --card:#121a34; --muted:#8aa0c6; --text:#ebf0ff;
      --border:#253055; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:linear-gradient(180deg,#0a0f1e,#0b1228 40%,#09102a);
      color:var(--text);
      font-size:16px;
    }
    header{
      position:sticky;top:0;z-index:5;
      background:rgba(9,16,42,.75);
      backdrop-filter:blur(10px);
      border-bottom:1px solid var(--border)
    }
    .wrap{max-width:1600px;margin:0 auto;padding:20px;}
    h1{margin:0;font-size:1.55rem;font-weight:800}
    .row{display:grid;grid-template-columns:1fr;gap:18px}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:20px;
    }
    .card h2{margin:0 0 12px;font-size:1.25rem}
    label{
      display:block;margin:12px 0 8px;color:var(--muted);
      font-size:1rem;font-weight:600;
    }
    input[type="text"],input[type="number"],input[type="date"],input[type="time"],input[type="email"],textarea,select{
      width:100%;padding:14px 14px;border-radius:14px;border:1px solid var(--border);
      background:#0f1732;color:var(--text);outline:none;font-size:1.05rem;
    }
    textarea{min-height:130px;resize:vertical}
    .grid-2,.grid-3,.grid-4{display:grid;grid-template-columns:1fr;gap:14px}
    @media (min-width:700px){
      .grid-2{grid-template-columns:1fr 1fr}
      .grid-3{grid-template-columns:1fr 1fr 1fr}
      .grid-4{grid-template-columns:1fr 1fr 1fr 1fr}
    }
    .muted{color:var(--muted);font-size:1rem}
    .btns{display:flex;flex-wrap:wrap;gap:12px;margin-top:16px}
    button,.btn{
      appearance:none;border:1px solid var(--border);background:#101a35;color:var(--text);
      border-radius:16px;padding:12px 16px;font-weight:700;cursor:pointer;
      box-shadow:var(--shadow);font-size:1.05rem;
    }
    button.success{background:#18a877;border-color:#159569}
    button.danger{background:#e74a3b;border-color:#c0392b}
    canvas#sigPad{
      width:100%;height:220px;background:#0f1732;border:1px dashed #2c3b6a;border-radius:14px
    }
    .thumbs{
      display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));
      gap:10px;margin-top:10px
    }
    .thumbs img{
      width:100%;height:100px;object-fit:cover;border-radius:12px;border:1px solid var(--border)
    }
    .footer{color:var(--muted);font-size:.95rem;margin-top:10px}
    .hidden{display:none !important;}
    .subhead{margin:8px 0 2px;font-size:1.05rem;font-weight:800;color:#dfe8ff}
  </style>
</head>

<body>
  <header>
    <div class="wrap"><h1>Reportes Técnicos – Versión Simple</h1></div>
  </header>

  <main class="wrap">
    <div class="row">
      <section class="card">
        <h2>Nuevo reporte</h2>

        <form id="reporteForm">
          <!-- Encabezado empresa (menú de ingenieros) -->
          <div class="subhead">Datos empresa (BHS)</div>
          <div class="grid-3">
            <div>
              <label>Ingeniería:</label>
              <select id="tecnicoBHS" required>
                <option value="" selected disabled>Seleccionar...</option>
                <option>Ing. Juan Carlos A</option>
                <option>Ing. Leonardo Chacón C</option>
              </select>
            </div>
            <div>
              <label>Teléfono (BHS)</label>
              <input type="text" id="phoneBHS" value="6037-4749" />
            </div>
            <div>
              <label>Email (BHS)</label>
              <input type="text" id="emailBHS" value="serviciotecncio@bennucr.com" />
            </div>
          </div>

          <div class="grid-4">
            <div>
              <label>N° de reporte (consecutivo)</label>
              <input type="text" id="numReporte" readonly />
              <div class="footer">Este número solo aumenta cuando generas PDF.</div>
            </div>
            <div>
              <label>Fecha</label>
              <input type="date" id="fecha" required />
            </div>
            <div>
              <label>Hora inicio</label>
              <input type="time" id="horaIni" required />
            </div>
            <div>
              <label>Hora fin</label>
              <input type="time" id="horaFin" required />
            </div>
          </div>

          <div class="grid-3">
            <div>
              <label>Cliente / Clínica / Hospital</label>
              <input type="text" id="cliente" required />
            </div>

            <div>
              <label>Responsable en sitio (cliente)</label>
              <input type="text" id="responsable" required placeholder="Nombre y apellido" />
            </div>

            <div>
              <label>Correo del cliente (para enviar PDF)</label>
              <input type="email" id="correo" placeholder="cliente@ejemplo.com" />
            </div>
          </div>

          <h3 class="muted">Equipo atendido</h3>
          <div class="grid-4">
            <div><label>Marca</label><input type="text" id="marca" required /></div>
            <div><label>Modelo</label><input type="text" id="modelo" required /></div>
            <div><label>N° de serie</label><input type="text" id="serie" required /></div>
            <div><label>Activo</label><input type="text" id="activo" /></div>
          </div>

          <div class="grid-2">
            <div>
              <label>Actuación</label>
              <select id="actuacion">
                <option>Mtto Preventivo</option>
                <option>Mtto Correctivo</option>
                <option>Instalación de Repuesto</option>
                <option>Otro</option>
              </select>
            </div>
            <div>
              <label>Cantidad</label>
              <input type="number" id="cantidad" step="0.1" min="0" value="1" />
            </div>
          </div>

          <label>Observaciones / diagnóstico</label>
          <textarea id="acciones" required></textarea>

          <div class="grid-3">
            <div><label>Repuestos utilizados</label><input type="text" id="repuestos" /></div>
            <div><label>Horas trabajadas</label><input type="number" id="horas" step="0.1" min="0" value="1" /></div>
            <div>
              <label>Estado final</label>
              <select id="estado">
                <option>Operativo</option>
                <option>Operativo con observaciones</option>
                <option>En espera de repuesto</option>
                <option>No operativo</option>
              </select>
            </div>
          </div>

          <label>Fotografías (evidencia)</label>
          <div class="btns">
            <button type="button" class="btn" id="btnFotosGaleria">Seleccionar de Fototeca / Archivos</button>
            <button type="button" class="btn" id="btnFotosCamara">Tomar foto (cámara)</button>
          </div>
          <input type="file" id="fotosGaleria" accept="image/*" multiple class="hidden" />
          <input type="file" id="fotosCamara" accept="image/*" capture="environment" multiple class="hidden" />
          <div id="thumbs" class="thumbs"></div>

          <!-- LOGO seleccionable + fijo -->
          <div class="grid-2">
            <div>
              <label>Logo de empresa</label>
              <input type="file" id="logoInput" accept="image/*" />
              <div class="btns">
                <button type="button" class="btn" id="btnFijarLogo">Fijar logo</button>
                <button type="button" class="btn danger" id="btnRestaurarLogo">Restaurar logo por defecto</button>
              </div>
              <div class="footer">Si no fijas uno, se usa el logo por defecto del repo: <strong>logo.png</strong>.</div>
            </div>

            <div>
              <label>Firma del cliente</label>
              <canvas id="sigPad"></canvas>
              <div class="btns">
                <button type="button" id="limpiarFirma" class="btn">Limpiar firma</button>
              </div>
            </div>
          </div>

          <div class="btns">
            <button type="button" class="success" id="pdf">Generar PDF</button>
            <button type="reset" class="danger" id="limpiarForm">Limpiar formulario</button>
          </div>

          <div class="footer">Consecutivo inicia en <strong>#95</strong> y solo se actualiza al generar PDF.</div>
        </form>
      </section>
    </div>
  </main>

  <!-- jsPDF (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <!-- Signature Pad -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@5.0.10/dist/signature_pad.umd.min.js"></script>

  <script>
    /*************** Config ***************/
    const HEADER = {
      company:   'Bennu Healthcare Solutions',
      legalId:   '3-101804878',
      address:   'Sabana Sur, Mata Redonda, Centro Comercial del Sur',
    };

    const DEFAULT_LOGO_URL = './logo.png';
    const CONSEC_START = 95;

    const LS_KEY_CONSEC = 'reportes_simple_consecutivo_last_used';
    const LS_KEY_LOGO   = 'reportes_simple_logo_fijo';

    /*************** Consecutivo ***************/
    function getLastUsed(){
      const raw = localStorage.getItem(LS_KEY_CONSEC);
      if (!raw) return (CONSEC_START - 1);
      const n = parseInt(raw, 10);
      return Number.isFinite(n) ? n : (CONSEC_START - 1);
    }
    function peekNext(){ return getLastUsed() + 1; }
    function commitUsed(used){ localStorage.setItem(LS_KEY_CONSEC, String(used)); }

    /*************** Logo fijo ***************/
    function getLogoFijo(){ return localStorage.getItem(LS_KEY_LOGO); }
    function setLogoFijo(dataURL){ localStorage.setItem(LS_KEY_LOGO, dataURL); }
    function clearLogoFijo(){ localStorage.removeItem(LS_KEY_LOGO); }

    async function fileOrBlobToDataURL(fileOrBlob){
      return new Promise((res,rej)=>{
        const r = new FileReader();
        r.onload = ()=>res(r.result);
        r.onerror = rej;
        r.readAsDataURL(fileOrBlob);
      });
    }

    async function ensureDefaultLogoLoaded(){
      if (getLogoFijo()) return;
      try{
        const res = await fetch(DEFAULT_LOGO_URL, { cache:'no-store' });
        if (!res.ok) return;
        const blob = await res.blob();
        const dataUrl = await fileOrBlobToDataURL(blob);
        setLogoFijo(dataUrl);
      }catch(e){
        console.warn('No se pudo cargar logo.png:', e);
      }
    }

    // Selección de logo
    const logoInput = document.getElementById('logoInput');
    let logoSeleccionado = null;

    logoInput.addEventListener('change', async (ev) => {
      const f = ev.target.files?.[0];
      if (!f) { logoSeleccionado = null; return; }
      logoSeleccionado = await fileOrBlobToDataURL(f);
      toast('Logo cargado. Presiona "Fijar logo" para guardarlo.');
    });

    document.getElementById('btnFijarLogo').addEventListener('click', async () => {
      if (!logoSeleccionado) { alert('Primero selecciona un logo.'); return; }
      setLogoFijo(logoSeleccionado);
      toast('Logo fijado ✅');
    });

    document.getElementById('btnRestaurarLogo').addEventListener('click', async () => {
      clearLogoFijo();
      await ensureDefaultLogoLoaded();
      toast('Logo por defecto restaurado ✅');
    });

    /*************** Firma ***************/
    const canvas = document.getElementById('sigPad');
    const signaturePad = new window.SignaturePad(canvas, { backgroundColor: 'rgba(0,0,0,0)' });

    function resizeCanvas(){
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      canvas.width = canvas.offsetWidth * ratio;
      canvas.height = canvas.offsetHeight * ratio;
      canvas.getContext('2d').setTransform(ratio,0,0,ratio,0,0);
      signaturePad.clear();
    }
    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('orientationchange', resizeCanvas);
    document.getElementById('limpiarFirma').addEventListener('click', () => signaturePad.clear());

    /*************** Fotos ***************/
    const thumbs = document.getElementById('thumbs');
    let fotosDataURLs = [];
    const fotosGaleria = document.getElementById('fotosGaleria');
    const fotosCamara  = document.getElementById('fotosCamara');

    document.getElementById('btnFotosGaleria').addEventListener('click', () => fotosGaleria.click());
    document.getElementById('btnFotosCamara').addEventListener('click', () => fotosCamara.click());

    fotosGaleria.addEventListener('change', (ev) => handleFotos(ev.target.files));
    fotosCamara.addEventListener('change',  (ev) => handleFotos(ev.target.files));

    async function handleFotos(fileList){
      const files = Array.from(fileList || []);
      if (!files.length) return;

      for (const f of files){
        const url = await fileOrBlobToDataURL(f);
        fotosDataURLs.push(url);
      }
      fotosGaleria.value = '';
      fotosCamara.value = '';
      refreshThumbs();
    }

    function refreshThumbs(){
      thumbs.innerHTML = '';
      for (const url of fotosDataURLs){
        const img = document.createElement('img');
        img.src = url;
        thumbs.appendChild(img);
      }
    }

    /*************** Utilidades ***************/
    function pad2(n){ return (n<10?'0':'') + n; }
    function initFechaHora(){
      const d = new Date();
      document.getElementById('fecha').value = d.toISOString().slice(0,10);
      const hhmm = pad2(d.getHours()) + ':' + pad2(d.getMinutes());
      document.getElementById('horaIni').value = hhmm;
      document.getElementById('horaFin').value = hhmm;
    }
    function calcDuracion(h1, h2){
      const [a,b] = h1.split(':').map(Number), [c,d] = h2.split(':').map(Number);
      let m1 = a*60+b, m2 = c*60+d; if (m2 < m1) m2 += 24*60;
      const dif = m2 - m1;
      return Math.floor(dif/60)+':'+pad2(dif%60);
    }
    function get(id){ return document.getElementById(id).value.trim(); }

    function formDataToObj(consecutivo){
      const firma = signaturePad.isEmpty() ? null : signaturePad.toDataURL('image/png');
      const dur = calcDuracion(get('horaIni'), get('horaFin'));
      return {
        consecutivo,
        fecha:get('fecha'), horaIni:get('horaIni'), horaFin:get('horaFin'), duracion:dur,
        cliente:get('cliente'),
        responsable:get('responsable'),
        correo:get('correo'),

        tecnicoBHS:get('tecnicoBHS'),
        phoneBHS:get('phoneBHS'),
        emailBHS:get('emailBHS'),

        marca:get('marca'), modelo:get('modelo'), serie:get('serie'),
        activo:get('activo'),
        actuacion:get('actuacion'), cantidad:get('cantidad'),
        acciones:get('acciones'),
        repuestos:get('repuestos'), horas:get('horas'), estado:get('estado'),
        fotos:fotosDataURLs,
        logo:getLogoFijo(),
        firma
      };
    }

    /*************** PDF ***************/
    function generarPDF(){
      const used = Number(document.getElementById('numReporte').value || peekNext());
      const obj = formDataToObj(used);

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'pt', format:'a4' });
      const M = 36;
      let y = M;

      // Helper: detecta formato real del dataURL (PNG/JPEG)
      function detectFormat(dataUrl){
        if (!dataUrl || typeof dataUrl !== 'string') return 'JPEG';
        if (dataUrl.startsWith('data:image/png')) return 'PNG';
        if (dataUrl.startsWith('data:image/webp')) return 'WEBP'; // por si acaso
        if (dataUrl.startsWith('data:image/jpg') || dataUrl.startsWith('data:image/jpeg')) return 'JPEG';
        return 'JPEG';
      }

      // Logo
      if (obj.logo){
        try { doc.addImage(obj.logo, detectFormat(obj.logo), M, y, 160, 80); } catch(e){}
      }

      const rightX = M + 180;
      doc.setFont('helvetica','bold'); doc.setFontSize(12);
      doc.text(HEADER.company, rightX, y+16);

      doc.setFont('helvetica','normal'); doc.setFontSize(10);
      doc.text(HEADER.legalId, rightX, y+34);
      doc.text(HEADER.address, rightX, y+50);

      doc.text(`Ingeniería: ${obj.tecnicoBHS || '-'}`, rightX, y+66);
      doc.text(`Email: ${obj.emailBHS || '-'}`, rightX, y+82);
      doc.text(`Tel: ${obj.phoneBHS || '-'}`, rightX, y+98);

      y += 130;
      doc.setDrawColor(120,140,170);
      doc.line(M, y, 595-M, y);

      y += 22;
      doc.setFont('helvetica','bold'); doc.setFontSize(12);
      doc.text(`Num. Orden de trabajo: ${String(obj.consecutivo).padStart(5,'0')}`, M, y);

      y += 18;
      doc.setFont('helvetica','normal'); doc.setFontSize(10);
      doc.text(`Fecha: ${obj.fecha}`, M, y);
      doc.text(`Hora Inicio: ${obj.horaIni}`, M+180, y);
      doc.text(`Hora Fin: ${obj.horaFin}`, M+340, y);
      doc.text(`Tiempo: ${obj.duracion}`, 595-M, y, { align:'right' });

      y += 18;
      doc.setDrawColor(120,140,170);
      doc.line(M, y, 595-M, y);

      y += 18;
      doc.setFont('helvetica','bold'); doc.setFontSize(11);
      doc.text('Observaciones / diagnóstico:', M, y);
      y += 14;
      doc.setFont('helvetica','normal'); doc.setFontSize(10);
      const obsLines = doc.splitTextToSize(obj.acciones || '-', 595 - 2*M);
      for (const line of obsLines){
        if (y > 770){ doc.addPage(); y = M; }
        doc.text(line, M, y); y += 12;
      }

      // ✅✅✅ BLOQUE AÑADIDO: Fotos en el PDF (esto es lo que faltaba)
      if (obj.fotos && obj.fotos.length){
        // título
        if (y > 720){ doc.addPage(); y = M; }
        y += 10;
        doc.setDrawColor(120,140,170);
        doc.line(M, y, 595-M, y);
        y += 18;

        doc.setFont('helvetica','bold'); doc.setFontSize(11);
        doc.text('Imágenes:', M, y);
        y += 10;

        const pageW = doc.internal.pageSize.getWidth();
        const pageH = doc.internal.pageSize.getHeight();
        const maxW = pageW - 2*M;
        const imgH = 320;     // alto estándar
        const gap = 14;

        for (let i=0; i<obj.fotos.length; i++){
          const dataUrl = obj.fotos[i];
          const fmt = detectFormat(dataUrl);

          // si no cabe, nueva página
          if (y + imgH + 40 > pageH){ doc.addPage(); y = M; }

          doc.setFont('helvetica','bold'); doc.setFontSize(10);
          doc.text(`Foto ${i+1}`, M, y+12);

          try{
            // Imagen
            doc.addImage(dataUrl, fmt, M, y+18, maxW, imgH);
          }catch(e){
            // si alguna imagen falla, continuamos sin romper todo el PDF
            doc.setFont('helvetica','normal'); doc.setFontSize(9);
            doc.text('(No se pudo insertar esta imagen)', M, y+30);
          }

          y += (imgH + 18 + gap);
        }
      }

      // Firma
      if (y > 650){ doc.addPage(); y = M; }
      doc.setFont('helvetica','bold'); doc.setFontSize(11);
      doc.text('Firma del cliente / conformidad', M, y);
      y += 10;
      doc.setDrawColor(80,100,140);
      doc.rect(M, y, 360, 130);
      if (obj.firma){
        try { doc.addImage(obj.firma, detectFormat(obj.firma), M+10, y+10, 340, 110); } catch(e){}
      }

      const nombre = `OT_${String(obj.consecutivo).padStart(5,'0')}_${(obj.marca||'Equipo')}_${(obj.modelo||'')}.pdf`
        .replace(/[^a-z0-9\-_\.]+/gi,'_');

      const blob = doc.output('blob');
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = nombre;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1500);

      commitUsed(used);
      document.getElementById('numReporte').value = peekNext();
      toast(`PDF generado. Siguiente: #${document.getElementById('numReporte').value}`);
    }

    document.getElementById('pdf').addEventListener('click', generarPDF);

    document.getElementById('limpiarForm').addEventListener('click', ()=>{
      setTimeout(()=>{
        signaturePad.clear();
        fotosDataURLs = [];
        refreshThumbs();
        initFechaHora();
        document.getElementById('numReporte').value = peekNext();
      }, 0);
    });

    function toast(msg){
      const d=document.createElement('div');
      d.textContent=msg;
      d.style.cssText='position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:#101a35;border:1px solid #253055;padding:10px 14px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35);z-index:9999;color:#ebf0ff;';
      document.body.appendChild(d);
      setTimeout(()=>d.remove(),2200);
    }

    async function init(){
      resizeCanvas();
      initFechaHora();
      await ensureDefaultLogoLoaded();
      document.getElementById('numReporte').value = peekNext();
      document.getElementById('tecnicoBHS').value = 'Ing. Juan Carlos A';
    }
    init();
  </script>
</body>
</html>
