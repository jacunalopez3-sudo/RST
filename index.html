<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reporte Técnico – Formato OT (BHS)</title>
  <meta name="description" content="Reporte técnico (PDF, consecutivo, firma y fotos) sin Service Worker." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1020; --card:#121a34; --muted:#8aa0c6; --text:#ebf0ff;
      --border:#253055; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:linear-gradient(180deg,#0a0f1e,#0b1228 40%,#09102a);
      color:var(--text);
      font-size:16px;
    }
    header{
      position:sticky;top:0;z-index:5;
      background:rgba(9,16,42,.75);
      backdrop-filter:blur(10px);
      border-bottom:1px solid var(--border)
    }
    .wrap{max-width:1600px;margin:0 auto;padding:20px;}
    h1{margin:0;font-size:1.55rem;font-weight:800}
    .row{display:grid;grid-template-columns:1fr;gap:18px}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:20px;
    }
    .card h2{margin:0 0 12px;font-size:1.25rem}
    label{
      display:block;margin:12px 0 8px;color:var(--muted);
      font-size:1rem;font-weight:600;
    }
    input[type="text"],input[type="number"],input[type="date"],input[type="time"],input[type="email"],textarea,select{
      width:100%;padding:14px 14px;border-radius:14px;border:1px solid var(--border);
      background:#0f1732;color:var(--text);outline:none;font-size:1.05rem;
    }
    textarea{min-height:130px;resize:vertical}
    .grid-2,.grid-3,.grid-4{display:grid;grid-template-columns:1fr;gap:14px}
    @media (min-width:700px){
      .grid-2{grid-template-columns:1fr 1fr}
      .grid-3{grid-template-columns:1fr 1fr 1fr}
      .grid-4{grid-template-columns:1fr 1fr 1fr 1fr}
    }
    .muted{color:var(--muted);font-size:1rem}
    .btns{display:flex;flex-wrap:wrap;gap:12px;margin-top:16px}
    button,.btn{
      appearance:none;border:1px solid var(--border);background:#101a35;color:var(--text);
      border-radius:16px;padding:12px 16px;font-weight:700;cursor:pointer;
      box-shadow:var(--shadow);font-size:1.05rem;
    }
    button.success{background:#18a877;border-color:#159569}
    button.danger{background:#e74a3b;border-color:#c0392b}
    canvas#sigPad{
      width:100%;height:220px;background:#0f1732;border:1px dashed #2c3b6a;border-radius:14px
    }
    .thumbs{
      display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));
      gap:10px;margin-top:10px
    }
    .thumbs img{
      width:100%;height:100px;object-fit:cover;border-radius:12px;border:1px solid var(--border)
    }
    .footer{color:var(--muted);font-size:.95rem;margin-top:10px}
    .hidden{display:none !important;}
    .subhead{margin:8px 0 2px;font-size:1.05rem;font-weight:800;color:#dfe8ff}
  </style>
</head>

<body>
  <header>
    <div class="wrap"><h1>Reporte Técnico – Formato OT (BHS)</h1></div>
  </header>

  <main class="wrap">
    <div class="row">
      <section class="card">
        <h2>Nuevo reporte</h2>

        <form id="reporteForm">
          <div class="subhead">Datos empresa (BHS)</div>
          <div class="grid-3">
            <div>
              <label>Ingeniería:</label>
              <select id="tecnicoBHS" required>
                <option value="" selected disabled>Seleccionar...</option>
                <option>Ing. Juan Carlos A</option>
                <option>Ing. Leonardo Chacón C</option>
              </select>
            </div>
            <div>
              <label>Teléfono (BHS)</label>
              <input type="text" id="phoneBHS" value="6037-4749" />
            </div>
            <div>
              <label>Email (BHS)</label>
              <input type="text" id="emailBHS" value="serviciotecncio@bennucr.com" />
            </div>
          </div>

          <div class="grid-4">
            <div>
              <label>N° de reporte (consecutivo)</label>
              <input type="text" id="numReporte" readonly />
              <div class="footer">Este número solo aumenta cuando generas PDF.</div>
            </div>
            <div>
              <label>Fecha</label>
              <input type="date" id="fecha" required />
            </div>
            <div>
              <label>Hora inicio</label>
              <input type="time" id="horaIni" required />
            </div>
            <div>
              <label>Hora fin</label>
              <input type="time" id="horaFin" required />
            </div>
          </div>

          <div class="grid-3">
            <div>
              <label>Cliente / Clínica / Hospital</label>
              <input type="text" id="cliente" required />
            </div>

            <div>
              <label>Responsable en sitio (cliente)</label>
              <input type="text" id="responsable" required placeholder="Nombre y apellido" />
            </div>

            <div>
              <label>Correo del cliente (para enviar PDF)</label>
              <input type="email" id="correo" placeholder="cliente@ejemplo.com" />
            </div>
          </div>

          <h3 class="muted">Equipo atendido</h3>
          <div class="grid-4">
            <div><label>Equipo</label><input type="text" id="equipo" required placeholder="Ej. Monitor de signos vitales" /></div>
            <div><label>Marca</label><input type="text" id="marca" required /></div>
            <div><label>Modelo</label><input type="text" id="modelo" required /></div>
            <div><label>N° de serie</label><input type="text" id="serie" required /></div>
          </div>
          <div class="grid-2">
            <div><label>Activo</label><input type="text" id="activo" /></div>
            <div><label>Ubicación / Servicio (opcional)</label><input type="text" id="ubicacion" placeholder="Ej. Sala de procedimientos" /></div>
          </div>

          <div class="grid-2">
            <div>
              <label>Actuación</label>
              <select id="actuacion">
                <option>Mtto Preventivo</option>
                <option>Mtto Correctivo</option>
                <option>Instalación de Repuesto</option>
                <option>Otro</option>
              </select>
            </div>
            <div>
              <label>Cantidad</label>
              <input type="number" id="cantidad" step="0.1" min="0" value="1" />
            </div>
          </div>

          <label>Observaciones / diagnóstico</label>
          <textarea id="acciones" required></textarea>

          <div class="grid-3">
            <div><label>Repuestos utilizados</label><input type="text" id="repuestos" /></div>
            <div><label>Horas trabajadas</label><input type="number" id="horas" step="0.1" min="0" value="1" /></div>
            <div>
              <label>Estado final</label>
              <select id="estado">
                <option>Operativo</option>
                <option>Operativo con observaciones</option>
                <option>En espera de repuesto</option>
                <option>No operativo</option>
              </select>
            </div>
          </div>

          <label>Fotografías (evidencia)</label>
          <div class="btns">
            <button type="button" class="btn" id="btnFotosGaleria">Seleccionar de Fototeca / Archivos</button>
            <button type="button" class="btn" id="btnFotosCamara">Tomar foto (cámara)</button>
          </div>
          <input type="file" id="fotosGaleria" accept="image/*" multiple class="hidden" />
          <input type="file" id="fotosCamara" accept="image/*" capture="environment" multiple class="hidden" />
          <div id="thumbs" class="thumbs"></div>

          <div class="grid-2">
            <div>
              <label>Logo de empresa</label>
              <input type="file" id="logoInput" accept="image/*" />
              <div class="btns">
                <button type="button" class="btn" id="btnFijarLogo">Fijar logo</button>
                <button type="button" class="btn danger" id="btnRestaurarLogo">Restaurar logo por defecto</button>
              </div>
              <div class="footer">Si no fijas uno, se usa el logo por defecto del repo: <strong>logo.png</strong>.</div>
            </div>

            <div>
              <label>Firma del cliente</label>
              <canvas id="sigPad"></canvas>
              <div class="btns">
                <button type="button" id="limpiarFirma" class="btn">Limpiar firma</button>
              </div>
            </div>
          </div>

          <div class="btns">
            <button type="button" class="success" id="pdf">Generar PDF (Formato OT)</button>
            <button type="reset" class="danger" id="limpiarForm">Limpiar formulario</button>
          </div>

          <div class="footer">Consecutivo inicia en <strong>#95</strong> y solo se actualiza al generar PDF.</div>
        </form>
      </section>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@5.0.10/dist/signature_pad.umd.min.js"></script>

  <script>
    /***************** CONFIG *****************/
    const HEADER = {
      company:   'Bennu Healthcare Solutions',
      legalId:   '3-101804878',
      address:   'Sabana Sur, Mata Redonda, Centro Comercial del Sur',
    };

    const DEFAULT_LOGO_URL = './logo.png';
    const CONSEC_START = 95;

    const LS_KEY_CONSEC = 'reportes_simple_consecutivo_last_used';
    const LS_KEY_LOGO   = 'reportes_simple_logo_fijo';

    /***************** CONSECTUIVO *****************/
    function getLastUsed(){
      const raw = localStorage.getItem(LS_KEY_CONSEC);
      if (!raw) return (CONSEC_START - 1);
      const n = parseInt(raw, 10);
      return Number.isFinite(n) ? n : (CONSEC_START - 1);
    }
    function peekNext(){ return getLastUsed() + 1; }
    function commitUsed(used){ localStorage.setItem(LS_KEY_CONSEC, String(used)); }

    /***************** LOGO FIJO *****************/
    function getLogoFijo(){ return localStorage.getItem(LS_KEY_LOGO); }
    function setLogoFijo(dataURL){ localStorage.setItem(LS_KEY_LOGO, dataURL); }
    function clearLogoFijo(){ localStorage.removeItem(LS_KEY_LOGO); }

    async function fileOrBlobToDataURL(fileOrBlob){
      return new Promise((res,rej)=>{
        const r = new FileReader();
        r.onload = ()=>res(r.result);
        r.onerror = rej;
        r.readAsDataURL(fileOrBlob);
      });
    }

    async function ensureDefaultLogoLoaded(){
      if (getLogoFijo()) return;
      try{
        const res = await fetch(DEFAULT_LOGO_URL, { cache:'no-store' });
        if (!res.ok) return;
        const blob = await res.blob();
        const dataUrl = await fileOrBlobToDataURL(blob);
        setLogoFijo(dataUrl);
      }catch(e){
        console.warn('No se pudo cargar logo.png:', e);
      }
    }

    const logoInput = document.getElementById('logoInput');
    let logoSeleccionado = null;

    logoInput.addEventListener('change', async (ev) => {
      const f = ev.target.files?.[0];
      if (!f) { logoSeleccionado = null; return; }
      logoSeleccionado = await fileOrBlobToDataURL(f);
      toast('Logo cargado. Presiona "Fijar logo" para guardarlo.');
    });

    document.getElementById('btnFijarLogo').addEventListener('click', async () => {
      if (!logoSeleccionado) { alert('Primero selecciona un logo.'); return; }
      setLogoFijo(logoSeleccionado);
      toast('Logo fijado ✅');
    });

    document.getElementById('btnRestaurarLogo').addEventListener('click', async () => {
      clearLogoFijo();
      await ensureDefaultLogoLoaded();
      toast('Logo por defecto restaurado ✅');
    });

    /***************** FIRMA *****************/
    const canvas = document.getElementById('sigPad');
    const signaturePad = new window.SignaturePad(canvas, { backgroundColor: 'rgba(0,0,0,0)' });

    function resizeCanvas(){
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      canvas.width = canvas.offsetWidth * ratio;
      canvas.height = canvas.offsetHeight * ratio;
      canvas.getContext('2d').setTransform(ratio,0,0,ratio,0,0);
      signaturePad.clear();
    }
    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('orientationchange', resizeCanvas);
    document.getElementById('limpiarFirma').addEventListener('click', () => signaturePad.clear());

    /***************** FOTOS *****************/
    const thumbs = document.getElementById('thumbs');
    let fotosDataURLs = [];
    const fotosGaleria = document.getElementById('fotosGaleria');
    const fotosCamara  = document.getElementById('fotosCamara');

    document.getElementById('btnFotosGaleria').addEventListener('click', () => fotosGaleria.click());
    document.getElementById('btnFotosCamara').addEventListener('click', () => fotosCamara.click());

    fotosGaleria.addEventListener('change', (ev) => handleFotos(ev.target.files));
    fotosCamara.addEventListener('change',  (ev) => handleFotos(ev.target.files));

    async function handleFotos(fileList){
      const files = Array.from(fileList || []);
      if (!files.length) return;

      for (const f of files){
        const url = await fileOrBlobToDataURL(f);
        fotosDataURLs.push(url);
      }
      fotosGaleria.value = '';
      fotosCamara.value = '';
      refreshThumbs();
    }

    function refreshThumbs(){
      thumbs.innerHTML = '';
      for (const url of fotosDataURLs){
        const img = document.createElement('img');
        img.src = url;
        thumbs.appendChild(img);
      }
    }

    /***************** UTIL *****************/
    function pad2(n){ return (n<10?'0':'') + n; }
    function initFechaHora(){
      const d = new Date();
      document.getElementById('fecha').value = d.toISOString().slice(0,10);
      const hhmm = pad2(d.getHours()) + ':' + pad2(d.getMinutes());
      document.getElementById('horaIni').value = hhmm;
      document.getElementById('horaFin').value = hhmm;
    }
    function calcDuracion(h1, h2){
      const [a,b] = h1.split(':').map(Number), [c,d] = h2.split(':').map(Number);
      let m1 = a*60+b, m2 = c*60+d; if (m2 < m1) m2 += 24*60;
      const dif = m2 - m1;
      return Math.floor(dif/60)+':'+pad2(dif%60);
    }
    function get(id){ return document.getElementById(id).value.trim(); }

    function formDataToObj(consecutivo){
      const firma = signaturePad.isEmpty() ? null : signaturePad.toDataURL('image/png');
      const dur = calcDuracion(get('horaIni'), get('horaFin'));
      return {
        consecutivo,
        fecha:get('fecha'), horaIni:get('horaIni'), horaFin:get('horaFin'), duracion:dur,

        cliente:get('cliente'),
        responsable:get('responsable'),
        correo:get('correo'),

        tecnicoBHS:get('tecnicoBHS'),
        phoneBHS:get('phoneBHS'),
        emailBHS:get('emailBHS'),

        equipo:get('equipo'),
        marca:get('marca'),
        modelo:get('modelo'),
        serie:get('serie'),
        activo:get('activo'),
        ubicacion:get('ubicacion'),

        actuacion:get('actuacion'),
        cantidad:get('cantidad'),

        acciones:get('acciones'),
        repuestos:get('repuestos'),
        horas:get('horas'),
        estado:get('estado'),

        fotos:fotosDataURLs,
        logo:getLogoFijo(),
        firma
      };
    }

    /***************** PDF - FORMATO OT PROFESIONAL *****************/
    function generarPDF_OT(){
      const used = Number(document.getElementById('numReporte').value || peekNext());
      const obj = formDataToObj(used);

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'pt', format:'a4' });

      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();

      // Márgenes y estilo
      const M = 36;
      const R = pageW - M;
      const B = pageH - M;
      const stroke = { r: 43, g: 52, b: 69 };     // #2b3445
      const light  = { r: 151, g: 166, b: 191 };  // #97a6bf
      const text   = { r: 17, g: 24, b: 39 };     // #111827

      function setStroke(s=stroke, w=1){
        doc.setDrawColor(s.r,s.g,s.b);
        doc.setLineWidth(w);
      }
      function rect(x,y,w,h, lw=1){
        setStroke(stroke, lw);
        doc.rect(x,y,w,h);
      }
      function line(x1,y1,x2,y2,lw=1){
        setStroke(stroke, lw);
        doc.line(x1,y1,x2,y2);
      }
      function txt(x,y,s, size=10, bold=false, col=text){
        doc.setTextColor(col.r,col.g,col.b);
        doc.setFont('helvetica', bold?'bold':'normal');
        doc.setFontSize(size);
        doc.text(String(s || ''), x, y);
      }
      function txtR(x,y,s, size=10, bold=false, col=text){
        doc.setTextColor(col.r,col.g,col.b);
        doc.setFont('helvetica', bold?'bold':'normal');
        doc.setFontSize(size);
        doc.text(String(s || ''), x, y, { align:'right' });
      }
      function label(x,y,s){
        txt(x,y,s,8,false,{r:77,g:95,b:122});
      }
      function detectFormat(dataUrl){
        if (!dataUrl || typeof dataUrl !== 'string') return 'JPEG';
        if (dataUrl.startsWith('data:image/png')) return 'PNG';
        if (dataUrl.startsWith('data:image/webp')) return 'WEBP';
        if (dataUrl.startsWith('data:image/jpg') || dataUrl.startsWith('data:image/jpeg')) return 'JPEG';
        return 'JPEG';
      }

      // Wrap seguro dentro de ancho + alto (para que no tape líneas)
      function wrapToLines(text, maxWidth, fontSize=10, bold=false){
        doc.setFont('helvetica', bold?'bold':'normal');
        doc.setFontSize(fontSize);
        const t = String(text || '-');
        return doc.splitTextToSize(t, maxWidth);
      }
      function drawFieldBox(x,y,w,h, title, valueText, opts={}){
        // Caja + título pequeño + valor con wrap dentro
        rect(x,y,w,h,1);
        label(x+8, y+12, title);
        const innerX = x+8;
        const innerY = y+26;
        const innerW = w-16;
        const innerH = h-34;
        const lines = wrapToLines(valueText || '-', innerW, 10, false);

        let yy = innerY;
        const lineH = 12;
        const maxLines = Math.max(1, Math.floor(innerH/lineH));
        for (let i=0;i<Math.min(lines.length, maxLines);i++){
          txt(innerX, yy, lines[i], 10, false);
          yy += lineH;
        }
        if (lines.length > maxLines){
          txt(innerX, y+h-8, '…', 12, true);
        }
      }

      function frame(){
        // marco sobrio por página
        setStroke(stroke,1);
        doc.rect(M-8, M-8, (R-(M-8)), (B-(M-8)));
      }

      let y = M;
      frame();

      /************** HEADER **************/
      const headerH = 110;
      rect(M, y, R-M, headerH, 1);

      // Logo placeholder area
      const logoX = M+10;
      const logoY = y+14;
      const logoW = 140;
      const logoH = 70;

      rect(logoX, logoY, logoW, logoH, 0.8);
      if (obj.logo){
        try { doc.addImage(obj.logo, detectFormat(obj.logo), logoX+2, logoY+2, logoW-4, logoH-4); } catch(e){}
      } else {
        label(logoX+50, logoY+38, 'LOGO');
      }

      const infoX = logoX + logoW + 12;
      txt(infoX, y+24, HEADER.company, 12, true);
      txt(infoX, y+40, `Cédula Jurídica: ${HEADER.legalId}`, 9, false);
      txt(infoX, y+54, HEADER.address, 9, false);
      txt(infoX, y+70, `Ingeniería: ${obj.tecnicoBHS || '-'}`, 9, false);
      txt(infoX, y+86, `Email: ${obj.emailBHS || '-'}   |   Tel: ${obj.phoneBHS || '-'}`, 9, false);

      y += headerH + 10;

      /************** OT ROW **************/
      const otH = 48;
      rect(M, y, R-M, otH, 1);

      txt(M+10, y+18, 'ORDEN DE TRABAJO (OT)', 12, true);
      txtR(R-10, y+18, `OT #${String(obj.consecutivo).padStart(5,'0')}`, 12, true);
      const rango = `${obj.horaIni || '--:--'}–${obj.horaFin || '--:--'}`;
      txtR(R-10, y+36, `Fecha: ${obj.fecha || '-'}   Hora: ${rango}   Tiempo: ${obj.duracion || '-'}`, 9, false);

      y += otH + 10;

      /************** CLIENTE + EQUIPO (2 columnas) **************/
      const secH = 132;
      rect(M, y, R-M, secH, 1);
      const mid = M + (R-M)/2;
      line(mid, y, mid, y+secH, 1);

      // Titles
      txt(M+10, y+18, 'DATOS DEL CLIENTE', 9, true, {r:31,g:41,b:55});
      txt(mid+10, y+18, 'DATOS DEL EQUIPO', 9, true, {r:31,g:41,b:55});

      // Left fields
      const leftX = M+10;
      const leftW = (mid - M) - 20;
      drawFieldBox(leftX, y+24, leftW, 34, 'Cliente', obj.cliente || '-');
      drawFieldBox(leftX, y+62, leftW, 34, 'Responsable en sitio', obj.responsable || '-');
      drawFieldBox(leftX, y+100, leftW, 24, 'Correo', obj.correo || '-');

      // Right fields
      const rightX = mid+10;
      const rightW = (R - mid) - 20;
      drawFieldBox(rightX, y+24, rightW, 34, 'Equipo', obj.equipo || '-');
      drawFieldBox(rightX, y+62, rightW, 34, 'Marca / Modelo', `${obj.marca || '-'} / ${obj.modelo || '-'}`);
      drawFieldBox(rightX, y+100, rightW, 24, 'Serie / Activo', `${obj.serie || '-'} / ${obj.activo || '-'}`);

      y += secH + 10;

      /************** SERVICIO **************/
      const srvH = 66;
      rect(M, y, R-M, srvH, 1);
      txt(M+10, y+18, 'SERVICIO', 9, true, {r:31,g:41,b:55});

      // 3 columnas internas
      const col1 = M+10;
      const colW = (R-M-20)/3;
      drawFieldBox(col1,          y+22, colW-6, 40, 'Actuación', obj.actuacion || '-');
      drawFieldBox(col1+colW,     y+22, colW-6, 40, 'Cantidad', obj.cantidad || '-');
      drawFieldBox(col1+2*colW,   y+22, colW-6, 40, 'Estado final', obj.estado || '-');

      y += srvH + 10;

      /************** DETALLES (Repuestos / Horas / Ubicación) **************/
      const detH = 70;
      rect(M, y, R-M, detH, 1);
      txt(M+10, y+18, 'DETALLES', 9, true, {r:31,g:41,b:55});

      const detColW = (R-M-20)/2;
      drawFieldBox(M+10,          y+22, detColW-6, 44, 'Repuestos utilizados', obj.repuestos || '-');
      drawFieldBox(M+10+detColW,  y+22, detColW-6, 44, 'Horas trabajadas / Ubicación', `${obj.horas || '-'} h  |  ${obj.ubicacion || '-'}`);

      y += detH + 10;

      /************** OBSERVACIONES (auto-ajusta alto y páginas) **************/
      // Calcula alto necesario para observaciones con wrap, pero lo limita por página
      const obsTitleH = 18;
      const obsPadTop = 8;
      const obsPadX = 10;
      const maxObsW = (R-M) - 2*obsPadX;
      const obsLines = wrapToLines(obj.acciones || '-', maxObsW, 10, false);
      const lineH = 12;
      const obsTextH = Math.max(1, obsLines.length) * lineH;
      let obsBoxH = obsTitleH + obsPadTop + obsTextH + 12; // +12 para margen inferior

      // espacio mínimo para firma al final de la página si no hay fotos
      const reserveBottom = 170;

      function newPage(){
        doc.addPage();
        frame();
        y = M;
      }

      // Si no cabe el bloque completo, lo partimos por páginas
      function drawObsBlock(lines){
        // caja con altura según líneas
        const neededH = obsTitleH + obsPadTop + (lines.length*lineH) + 12;
        rect(M, y, R-M, neededH, 1);
        txt(M+10, y+14, 'OBSERVACIONES / DIAGNÓSTICO', 9, true, {r:31,g:41,b:55});

        let yy = y + 28;
        doc.setFont('helvetica','normal');
        doc.setFontSize(10);
        doc.setTextColor(text.r,text.g,text.b);
        for (const ln of lines){
          txt(M+10, yy, ln, 10, false);
          yy += lineH;
        }
        y += neededH + 10;
      }

      // Cuántas líneas caben en la página restante (dejando reserva)
      function linesThatFit(){
        const available = (B - reserveBottom) - y;
        const availInside = available - (obsTitleH + obsPadTop + 12);
        return Math.max(3, Math.floor(availInside / lineH));
      }

      let idx = 0;
      while (idx < obsLines.length){
        const fit = linesThatFit();
        const chunk = obsLines.slice(idx, idx+fit);
        // Si no cabe ni el mínimo, nueva página
        const minNeeded = obsTitleH + obsPadTop + (3*lineH) + 12;
        if (y + minNeeded > (B - reserveBottom)) newPage();
        drawObsBlock(chunk);
        idx += fit;
        if (idx < obsLines.length) newPage();
      }
      if (obsLines.length === 0){
        if (y + 80 > (B - reserveBottom)) newPage();
        drawObsBlock(['-']);
      }

      /************** IMÁGENES (2 por página, con marcos; nunca tapa líneas) **************/
      if (obj.fotos && obj.fotos.length){
        const imgsTitleH = 22;
        const boxPad = 10;
        const imgsBoxH = 250;

        function drawImagesPage(images){
          if (y + imgsTitleH + imgsBoxH + 10 > B - 170) newPage();

          rect(M, y, R-M, imgsTitleH + imgsBoxH, 1);
          txt(M+10, y+16, 'IMÁGENES', 9, true, {r:31,g:41,b:55});

          const innerX = M + boxPad;
          const innerY = y + imgsTitleH +
